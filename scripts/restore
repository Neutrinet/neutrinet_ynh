#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source /usr/share/yunohost/helpers
source _common.sh

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

ynh_abort_if_errors

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME

domain=$(ynh_app_setting_get $app domain)
path_url=$(ynh_app_setting_get $app path_url)
app_user=$(ynh_app_setting_get $app app_user)
www_path=$(ynh_app_setting_get $app www_path)
opt_path=$(ynh_app_setting_get $app opt_path)

#=================================================
# CHECK IF THE APP CAN BE RESTORED
#=================================================

ynh_print_info "Checking for conflicts..."

test ! -e "$www_path" || ynh_die "The path $www_path already contains a folder"
test ! -e "$opt_path" || ynh_die "The path $opt_path already contains a folder"

# Check web path availability
ynh_webpath_available $domain $path_url || ynh_die "$domain$path_url is no longer available"

#=================================================
# STANDARD MODIFICATIONS
#=================================================
# INSTALL DEPENDENCIES
#=================================================

ynh_print_info "Installing dependencies..."

apt-get update
ynh_install_app_dependencies git virtualenv python-virtualenv

#=================================================
# CREATE DEDICATED USER
#=================================================

mkdir --parents $www_path
useradd $app_user --home-dir=$www_path

#=================================================
# RESTORE THE APP MAIN DIR
#=================================================

ynh_print_info "Restoring files..."

ynh_restore_file "$www_path"
ynh_restore_file "/etc/nginx/conf.d/$domain.d/$app.conf"
chown -R $app_user: $www_path

ynh_restore_file "$opt_path"
ynh_restore_file "/etc/cron.daily/$app-renew-cert"
chown root:root /etc/cron.daily/$app-renew-cert
chmod 0755 /etc/cron.daily/$app-renew-cert

