set -e

source ./commons

install_renew_cert() {
    set -e

    install_dir=$(pwd)

    if [ -e $RENEW_CERT_PATH ]; then
        sudo rm -rf $RENEW_CERT_PATH
    fi

    sudo apt-get install -y python-virtualenv

    sudo git clone https://github.com/neutrinet/renew_cert $RENEW_CERT_PATH

    cd $RENEW_CERT_PATH

    sudo git checkout 41cd097fb6aa6799c2e94d8d500ad6e2440c5e86 || echo ""

    # I need system site packages otherwise moulinette is broken
    sudo virtualenv ve --system-site-packages
    sudo ve/bin/pip install -r requirements.txt

    cd $install_dir
}

renew_cert() {
    set -e

    install_dir=$(pwd)

    cd $RENEW_CERT_PATH
    sudo ve/bin/python renew_from_cube.py

    cd $install_dir
}

sudo yunohost app setting neutrinet version -v "0.1"

sudo yunohost app fetchlist -n neutrinet -u https://neutrinet.be/apps.json
sudo yunohost app fetchlist -n labriqueinternet -u https://labriqueinter.net/apps/labriqueinternet.json

install_renew_cert

# vpn is not running, let's assume for now that this mean that the vpn is broken
if [ ! "$(grep '^port 1195' /etc/openvpn/client.conf)" ]; then
    renew_cert
fi
